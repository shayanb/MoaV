name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate version
        run: |
          TAG_VERSION="${GITHUB_REF#refs/tags/v}"
          FILE_VERSION=$(cat VERSION)
          if [ "$TAG_VERSION" != "$FILE_VERSION" ]; then
            echo "Error: Tag version ($TAG_VERSION) does not match VERSION file ($FILE_VERSION)"
            exit 1
          fi
          echo "Version: $TAG_VERSION"

      - name: Extract changelog
        id: changelog
        run: |
          VERSION="${GITHUB_REF#refs/tags/v}"
          # Extract section for this version from CHANGELOG.md
          NOTES=$(awk -v ver="## [$VERSION]" '
            $0 ~ ver { found=1; next }
            found && /^## \[/ { exit }
            found { print }
          ' CHANGELOG.md)

          # Save to file for later use
          echo "$NOTES" > changelog_notes.txt
          echo "Extracted changelog for version $VERSION"

      - name: Check existing release
        id: existing
        run: |
          TAG="${GITHUB_REF#refs/tags/}"
          if gh release view "$TAG" --json body -q .body > existing_body.txt 2>/dev/null; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "Found existing release for $TAG"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "No existing release for $TAG"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Build release body
        id: body
        run: |
          # Define the install guide section
          cat > install_guide.txt << 'GUIDE_EOF'

          ---

          ## Quick Install

          ```bash
          curl -fsSL moav.sh/install.sh | bash
          ```

          This will install MoaV to `/opt/moav` and guide you through setup.

          ## Documentation

          - [Setup Guide](https://github.com/shayanb/MoaV/blob/main/docs/SETUP.md) - Complete installation instructions
          - [Client Setup](https://github.com/shayanb/MoaV/blob/main/docs/CLIENTS.md) - How to connect from devices
          - [DNS Configuration](https://github.com/shayanb/MoaV/blob/main/docs/DNS.md) - DNS records setup
          - [Troubleshooting](https://github.com/shayanb/MoaV/blob/main/docs/TROUBLESHOOTING.md) - Common issues and solutions
          GUIDE_EOF

          if [ "${{ steps.existing.outputs.exists }}" = "true" ]; then
            # Check if install guide already present in existing body
            if grep -q "## Quick Install" existing_body.txt; then
              echo "Install guide already present, keeping existing body"
              cp existing_body.txt release_body.txt
            else
              echo "Appending install guide to existing body"
              cat existing_body.txt > release_body.txt
              cat install_guide.txt >> release_body.txt
            fi
          else
            echo "Creating new release body with changelog + install guide"
            cat changelog_notes.txt > release_body.txt
            cat install_guide.txt >> release_body.txt
          fi

          echo "Final release body:"
          cat release_body.txt

      - name: Create or Update Release
        run: |
          TAG="${GITHUB_REF#refs/tags/}"

          # Determine if prerelease
          PRERELEASE=""
          if echo "$TAG" | grep -qE "(alpha|beta|rc)"; then
            PRERELEASE="--prerelease"
          fi

          if [ "${{ steps.existing.outputs.exists }}" = "true" ]; then
            echo "Updating existing release..."
            gh release edit "$TAG" \
              --title "MoaV $TAG" \
              --notes-file release_body.txt \
              $PRERELEASE
          else
            echo "Creating new release..."
            gh release create "$TAG" \
              --title "MoaV $TAG" \
              --notes-file release_body.txt \
              $PRERELEASE
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
